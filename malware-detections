# Malware DataModel Search

Pipe the summary data from every AV event from your security logs into a risk index with an equal score of "1". You can always adjust the score dynamically using eval statements like deomnstrated in the search.

#Malware Customization Requirements

There is no datamodel field for severity, so rather than modify the datamodel itself I created tags through eventtypes for each severity that would get pulled into the datamodel as a tag name based on the correlating severity. Splunk should really add that field to the Malware datamodel.

## Eventtypes Created with associated tag
search: index=malware sourcetype=av-vendor tag=malware event.SeverityName="informational"
tag: av_informational
search: index=malware sourcetype=av-vendor tag=malware event.SeverityName="low"
tag: av_low
search: index=malware sourcetype=av-vendor tag=malware event.SeverityName="medium"
tag: av_medium
search: index=malware sourcetype=av-vendor tag=malware event.SeverityName="high"
tag: av_high
search: index=malware sourcetype=av-vendor tag=malware event.SeverityName="critical"
tag: av_critical

## Search String

| tstats `summariesonly` count from datamodel=Malware.Malware_Attacks where NOT (sourcetype="email_security_logs" AND Malware_Attacks.action="blocked")  by Malware_Attacks.dest,Malware_Attacks.user,Malware_Attacks.tag,Malware_Attacks.action,Malware_Attacks.file_hash, Malware_Attacks.file_name,Malware_Attacks.signature,Malware_Attacks.url,sourcetype,index | `drop_dm_object_name("Malware_Attacks")`
| eval risk_object_type=if(sourcetype="CrowdStrike:Event:Streams:JSON", "system", "user")
| eval risk_object=if(sourcetype="CrowdStrike:Event:Streams:JSON", 'dest', 'user')
| eval severity=case(tag=="av_informational", "informational", tag=="av_low", "low", tag=="av_medium", "medium", tag=="av_high", "high", tag=="av_critical", "critical", sourcetype="email_security_logs", "medium")
| eval risk_score=case(match(severity,"formational") AND match(action, "llowed"), "5",match(severity,"ow") AND match(action, "llowed"), "25", match(severity,"edium") AND match(action, "llowed"), "50", match(severity,"igh") AND match(action, "llowed"), "75", match(severity,"ritical") AND match(action, "llowed"), "100",match(signature, "ansom"),500, 1==1, "1")
| eval savedsearch_description="malware behavior"
| table dest,user,action,severity,file_hash,file_name,signature,url,sourcetype,index, risk_*
| collect index=risk

### email_security_logs comments

I forced the malware events from our email security gateway into the malware datamodel based on my desired functionality. One of the reasons I like having a dev prodcut for a security tool and SIEM. It just took a tagged eventtype and field mapping to the common information model.

## Schedule
Scheduled(never real time)

cron
*/5,*,*,*,*

duration
earliest: -8m@m, latest: -3m@m

### Schedule reasoning
this puts the schedule on a regular but limited window to help with performance while capturing every event.

## Throttling
dest,user,action,severity,file_hash,file_name,signature,url,sourcetype,index for 9 minutes

### Throttling reasoining
remove the duplicates completely
